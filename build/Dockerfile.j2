# Use Red Hat UBI 8 as the base image
FROM registry.access.redhat.com/ubi8/python-39

# Switch to root user for package installation
USER root

# Set Python version
ENV PYTHON_VERSION="3.11"

# Update system and install Python 3.11
RUN yum -y update \
    && yum -y install openssl python${PYTHON_VERSION} python${PYTHON_VERSION}-pip \
    && yum -y clean all

# Set working directory for the application
WORKDIR /app

# Copy the entire vault_bridge directory
COPY ../vault_bridge /app/vault_bridge

# Install required Python dependencies, including boto3 and botocore
RUN python3 -m pip install -I Flask==2.3.2 gunicorn==21.2.0 requests==2.31.0 \
    pyjwt[crypto]==2.8.0 boto3==1.34.30 botocore==1.34.30

# Remove unnecessary OpenSSL libraries to reduce image size
RUN yum remove -y openssl \
    && yum -y clean all

# Add metadata labels
LABEL name="zen-vault-bridge" \
    vendor="IBM" \
    version=$IMAGE_VERSION_TAG \
    release=$IMAGE_VERSION_TAG \
    summary="zen-vault-bridge integrates IBM CloudPak zen-secrets-v2 with Vault" \
    description="zen-vault-bridge implements integration between IBM CloudPak zen-secrets-v2 and Vault, hosted in the cloud or on-prem."

# Switch back to a non-root user for security
USER 1001

# Expose application port (8043 instead of 8443)
EXPOSE 8043

# Run the application using Gunicorn, now pointing to the correct module
CMD ["gunicorn", "-b", "0.0.0.0:8043", "vault_bridge.wsgi:app"]
